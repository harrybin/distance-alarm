name: ðŸ¤– Continuous Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type to run"
        required: false
        default: "full"
        type: choice
        options:
          - full
          - android-only
          - quality-check-only
      environment:
        description: "Target environment"
        required: false
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production

env:
  DOTNET_VERSION: "9.0.x"
  PROJECT_PATH: "./DistanceAlarm.csproj"

jobs:
  build-android:
    name: ðŸš€ Build Android
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.build_type || github.event.inputs.build_type == 'full' || github.event.inputs.build_type == 'android-only' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ï¿½ Display Workflow Inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸŽ¯ Workflow triggered manually with inputs:"
          echo "Build Type: ${{ github.event.inputs.build_type }}"
          echo "Environment: ${{ github.event.inputs.environment }}"

      - name: ï¿½ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ› ï¸ Install MAUI Workload
        run: dotnet workload install maui-android

      - name: ðŸ“¦ Restore NuGet Packages
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: ðŸ—ï¸ Build Android Debug
        run: dotnet build ${{ env.PROJECT_PATH }} -f net9.0-android -c Debug

      - name: âœ… Build Android Release
        run: dotnet build ${{ env.PROJECT_PATH }} -f net9.0-android -c Release

      - name: ðŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: android-build-artifacts
          path: |
            bin/Debug/net9.0-android/
            bin/Release/net9.0-android/
          retention-days: 7

  code-quality:
    name: ðŸ” Code Quality Checks
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.build_type || github.event.inputs.build_type == 'full' || github.event.inputs.build_type == 'quality-check-only' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore Dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: ðŸ”¬ Run Code Analysis
        run: dotnet build ${{ env.PROJECT_PATH }} --verbosity normal --configuration Release

      - name: ðŸ§ª Run Tests (if any)
        run: dotnet test --no-build --verbosity normal --configuration Release || echo "No tests found"

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.build_type || github.event.inputs.build_type == 'full' || github.event.inputs.build_type == 'quality-check-only' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: Dependency Check
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt
          if grep -q "has the following vulnerable packages" vulnerability-report.txt; then
            echo "âš ï¸ Vulnerable packages found!"
            cat vulnerability-report.txt
            exit 1
          else
            echo "âœ… No vulnerable packages found"
          fi

  status-check:
    name: ðŸ“‹ Build Status Summary
    runs-on: ubuntu-latest
    needs: [build-android, code-quality, security-scan]
    if: always()

    steps:
      - name: ðŸ“Š Report Status
        run: |
          echo "## ðŸŽ¯ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Android Build | ${{ needs.build-android.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Success' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-android.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "ðŸŽ‰ All checks passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some checks failed. Please review before merging." >> $GITHUB_STEP_SUMMARY
          fi
